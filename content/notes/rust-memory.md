+++
title = "Rust内存及生命周期"
weight = 1
order = 1
date = 2020-02-17
#insert_anchor_links = "right"

[taxonomies]
tags = ["notes"]
+++

- `std::mem::drop`

  - ```rust
    pub fn drop<T>(_x :T) {}
    ```

  - 将变量所有权移入函数内部，返回时就会被析构

- 变量遮蔽不会导致生命周期提前结束

- 用下划线绑定变量会使变量当场析构

- 带析构函数的类型不满足`Copy`语义

  - 多个副本调用多次析构函数会出现内存安全问题

- 编译器会为变量插入一个标记是否`drop`过的标记

  - 保证程序中某变量可能在多个位置被`drop`时的语义正确性

- 借用/引用的语义是变量对其所指向内存无所有权

- `'a : 'b`：a活得长

- 生命周期协变

  - 传入被调用函数进行检查时可能生命周期会被缩短到某个值进行匹配

- 生命周期无智能推导规则，只匹配固定规则

  - 每个带生命周期参数的输入参数，每个对应不同的生命周期参数
  - 如果只有一个输入参数带生命周期参数，那么返回值的生命周期被指定为这个参数
  - 如果有多个输入参数带生命周期参数，但其中有`&self`、`&mut self`，那么返回值的生命周期被指定为这个参数

- `elision != inference`

- 安全机制的本质：

  - 编译阶段读者写者锁

- 协变看的云里雾里的，遇到了再来补
